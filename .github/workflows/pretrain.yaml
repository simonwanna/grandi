name: Pretrain & Deploy

on:
  workflow_dispatch:  # run manually

jobs:
  # --- JOB 1: TRAIN ---
  train:
    runs-on: ubuntu-latest
    env:
      BUCKET_NAME: ${{ vars.BUCKET_NAME }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
          pip install google-cloud-storage

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Pre-train and Upload
        env:
          PYTHONPATH: .
        run: |
          python ml/pretrain.py

  # --- JOB 2: DEPLOY ---
  deploy:
    needs: train  # Waits for 'train' to finish successfully
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      BUCKET_NAME: ${{ vars.BUCKET_NAME }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}  # Passed to deploy.sh if needed
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          chmod +x scripts/deploy_cloudrun.sh
          ./scripts/deploy_cloudrun.sh

      - name: Fetch Service URL
        run: |
          url=$(gcloud run services describe chess-inference --platform managed --region europe-north1 --format 'value(status.url)')
          echo "Expected Service URL: $url"
          echo "SERVICE_URL=$url" >> $GITHUB_ENV

      - name: Run Integration Tests
        env:
          SERVICE_URL: ${{ env.SERVICE_URL }}
        run: |
          pip install pytest httpx python-dotenv
          pytest tests/test_e2e.py